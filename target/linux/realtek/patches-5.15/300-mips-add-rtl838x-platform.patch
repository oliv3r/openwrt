From fce11f68491b46b93df69de0630cd9edb90bc772 Mon Sep 17 00:00:00 2001
From: Birger Koblitz <git@birger-koblitz.de>
Date: Wed, 29 Dec 2021 21:54:21 +0100
Subject: [PATCH] realtek: Create 4 different Realtek Platforms

Creates REALTEK_SOC as a basic kernel config parameter for the
RTL838X, RTL839x, RTL930X and RTL931X platforms with respective
configurations for the SoCs, which are introduced in addition.

Submitted-by: Birger Koblitz <git@birger-koblitz.de>
---
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -155,7 +155,7 @@
 	select NO_EXCEPT_FILL
 	select PCI_DRIVERS_GENERIC
 	select SMP_UP if SMP
-	select SWAP_IO_SPACE
+	select SWAP_IO_SPACE if (!SYS_HAS_BIG_ENDIAN_LEXRA_BUS || !CPU_BIG_ENDIAN)
 	select SYS_HAS_CPU_MIPS32_R1
 	select SYS_HAS_CPU_MIPS32_R2
 	select SYS_HAS_CPU_MIPS32_R6
@@ -625,27 +625,6 @@ config RALINK
 	select ARCH_HAS_RESET_CONTROLLER
 	select RESET_CONTROLLER
 
-config MACH_REALTEK_RTL
-	bool "Realtek RTL838x/RTL839x based machines"
-	select MIPS_GENERIC
-	select DMA_NONCOHERENT
-	select IRQ_MIPS_CPU
-	select CSRC_R4K
-	select CEVT_R4K
-	select SYS_HAS_CPU_MIPS32_R1
-	select SYS_HAS_CPU_MIPS32_R2
-	select SYS_SUPPORTS_BIG_ENDIAN
-	select SYS_SUPPORTS_32BIT_KERNEL
-	select SYS_SUPPORTS_MIPS16
-	select SYS_SUPPORTS_MULTITHREADING
-	select SYS_SUPPORTS_VPE_LOADER
-	select SYS_HAS_EARLY_PRINTK
-	select SYS_HAS_EARLY_PRINTK_8250
-	select USE_GENERIC_EARLY_PRINTK_8250
-	select BOOT_RAW
-	select PINCTRL
-	select USE_OF
-
 config SGI_IP22
 	bool "SGI IP22 (Indy/Indigo2)"
 	select ARC_MEMORY
@@ -2049,6 +2049,10 @@
 config SYS_HAS_CPU_XLP
 	bool
 
+config SYS_HAS_BIG_ENDIAN_LEXRA_BUS
+	bool
+	default n
+
 #
 # CPU may reorder R->R, R->W, W->R, W->W
 # Reordering beyond LL and SC is handled in WEAK_REORDERING_BEYOND_LLSC
--- a/arch/mips/generic/Kconfig
+++ b/arch/mips/generic/Kconfig
@@ -114,6 +114,27 @@ config BOARD_INGENIC
 	help
 	  Enable support for boards based on Ingenic SoCs.
 
+config REALTEK_SOC
+	bool "Support boards based on Realtek SoCs"
+	select ARCH_HAS_RESET_CONTROLLER
+	select CPU_SUPPORTS_CPUFREQ
+	select MIPS_EXTERNAL_TIMER
+	select PINCTRL
+	select RESET_CONTROLLER
+	select SYS_HAS_BIG_ENDIAN_LEXRA_BUS
+	select SYS_HAS_EARLY_PRINTK
+	select SYS_HAS_EARLY_PRINTK_8250
+	select SYS_SUPPORTS_32BIT_KERNEL
+	select SYS_SUPPORTS_BIG_ENDIAN
+	select SYS_SUPPORTS_HIGHMEM
+	select SYS_SUPPORTS_MIPS16
+	select SYS_SUPPORTS_VPE_LOADER
+	select SYS_SUPPORTS_ZBOOT_UART16550
+	select USE_GENERIC_EARLY_PRINTK_8250
+	help
+	  Support for Realtek based SoCs such as RTL838x, RTL839x,
+	  RTL930x and RTL931x.
+
 config VIRT_BOARD_RANCHU
 	bool "Support Ranchu platform for Android emulator"
 	help
--- a/arch/mips/generic/Makefile
+++ b/arch/mips/generic/Makefile
@@ -12,4 +12,5 @@ obj-$(CONFIG_YAMON_DT_SHIM)		+= yamon-dt
 obj-$(CONFIG_LEGACY_BOARD_SEAD3)	+= board-sead3.o
 obj-$(CONFIG_LEGACY_BOARD_OCELOT)	+= board-ocelot.o
 obj-$(CONFIG_MACH_INGENIC)			+= board-ingenic.o
+obj-$(CONFIG_REALTEK_SOC)		+= board-realtek.o
 obj-$(CONFIG_VIRT_BOARD_RANCHU)		+= board-ranchu.o
--- a/arch/mips/Kconfig.debug
+++ b/arch/mips/Kconfig.debug
@@ -98,6 +98,56 @@
 	  to reduce the kernel image size and speed up the booting procedure a
 	  little.
 
+config ZBOOT_UART
+	int "UART number"
+	depends on DEBUG_ZBOOT
+	default 0
+	range 0 1 if REALTEK_SOC
+	help
+	  Specify the UART, e.g 0, for uart0. Note that this only works
+	  on consecutive UART blocks. As an alternative, keep this set
+	  to 0 and use ZBOOT_UART_ADDR instead.
+
+config ZBOOT_UART_ADDR
+	hex "UART base address"
+	depends on DEBUG_ZBOOT
+	default 0x18002000 if REALTEK_SOC
+	help
+	  Specify the UART base register address for the first UART.
+
+config ZBOOT_UART_ADDR_SIZE
+	hex "UART register block size"
+	depends on DEBUG_ZBOOT
+	default 0x1000 if REALTEK_SOC
+	help
+	  Specify the UART register size between each UART.
+
+config ZBOOT_UART_MULTI
+	int "UART address multiplier/shift"
+	depends on DEBUG_ZBOOT
+	default 4
+	help
+	  Specify the UART address multiplier, or 'shift'. E.g. 4 (a shift
+	  of 2) for 32bit addresses.
+
+choice
+	prompt "UART IO Access type"
+	depends on DEBUG_ZBOOT
+	default ZBOOT_UART_IOTYPE_U32 if REALTEK_SOC
+	default ZBOOT_UART_IOTYPE_U8
+
+config ZBOOT_UART_IOTYPE_U32
+	bool "unsigned 32bit IO type"
+	help
+	  Unsigned 32 bit IOTYPE, e.g. unsigned int.
+
+config ZBOOT_UART_IOTYPE_U8
+	bool "unsigned 8bit IO type"
+	help
+	  Unsigned 8 bit IOTYPE, e.g. char
+
+endchoice
+
 config ZBOOT_INGENIC_UART
 	int "UART to use for compressed kernel debugging"
 	depends on DEBUG_ZBOOT && MACH_INGENIC_SOC
--- a/arch/mips/boot/compressed/uart-16550.c
+++ b/arch/mips/boot/compressed/uart-16550.c
@@ -35,6 +35,17 @@
 #define IOTYPE unsigned int
 #endif
 
+#ifdef CONFIG_ZBOOT_UART_ADDR
+#define UART_BASE ((CONFIG_ZBOOT_UART_ADDR) + ((CONFIG_ZBOOT_UART_ADDR_SIZE) * (CONFIG_ZBOOT_UART)))
+#define PORT(offset) (CKSEG1ADDR(UART_BASE) + ((CONFIG_ZBOOT_UART_MULTI) * (offset)))
+#endif
+
+#ifdef CONFIG_ZBOOT_UART_IOTYPE_U32
+#define IOTYPE unsigned int
+#elif CONFIG_ZBOOT_UART_IOTYPE_U8
+#define IOTYPE char
+#endif
+
 #ifndef IOTYPE
 #define IOTYPE char
 #endif
